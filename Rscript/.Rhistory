col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
objective = function(w) {
obj = t(w) %*% covmat %*% w
return(obj)
}
heq.objective = function(w) {
sum_w = sum(w)
return( sum_w - 1 )
}
result = slsqp( x0 = rep(1/length(symbols),length(symbols)),
fn = objective,
hin = hin.objective,
heq = heq.objective)
print(result$par)
covmat = cov(rets)
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
rets = Return.calculate(prices) %>% na.omit()
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
rets
covmat = cov(rets)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind,
lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
prices
rets = Return.calculate(prices) %>% na.omit()
rest
rets
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
covmat = cov(rets)
objective = function(w) {
obj = t(w) %*% covmat %*% w
return(obj)
}
hin.objective = function(w) {
return(w)
}
heq.objective = function(w) {
sum_w = sum(w)
return( sum_w - 1 )
}
result = slsqp( x0 = rep(1/length(symbols),length(symbols)),
fn = objective,
hin = hin.objective,
heq = heq.objective)
result
print(result$par)
print(result$value)
w_1 = result$par %>% round(., 4) %>%
setNames(colnames(rets))
print(w_1)
library(cccp)
opt = rp(x0 = rep(1/length(symbols),length(symbols)),
P = covmat,
mrc = rep(1/length(symbols),length(symbols)))
w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
round(., 4) %>%
setNames(colnames(rets))
print(w)
w*5000
symbols = c('ARKK',
'JETS',
'PBW',
'XLY',
'XLP',
'NRGU',
'PAVE',
'FNGU',
'UPRO'
)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind,
lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
covmat = cov(rets)
objective = function(w) {
obj = t(w) %*% covmat %*% w
return(obj)
}
hin.objective = function(w) {
return(w)
}
heq.objective = function(w) {
sum_w = sum(w)
return( sum_w - 1 )
}
result = slsqp( x0 = rep(1/length(symbols),length(symbols)),
fn = objective,
hin = hin.objective,
heq = heq.objective)
print(result$par)
print(result$value)
w_1 = result$par %>% round(., 4) %>%
setNames(colnames(rets))
print(w_1)
library(cccp)
opt = rp(x0 = rep(1/length(symbols),length(symbols)),
P = covmat,
mrc = rep(1/length(symbols),length(symbols)))
w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
round(., 4) %>%
setNames(colnames(rets))
print(w)
w*5000
library(quantmod)
library(PerformanceAnalytics)
library(magrittr)
library(tidyr)
library(dplyr)
library(corrplot)
library(nloptr)
symbols = c('ARKK',
'JETS',
'PBW',
'XLY',
'XLP',
'NRGU',
'PAVE',
'FNGU',
'SOXL'
)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind,
lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
covmat = cov(rets)
library(cccp)
opt = rp(x0 = rep(1/length(symbols),length(symbols)),
P = covmat,
mrc = rep(1/length(symbols),length(symbols)))
w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
round(., 4) %>%
setNames(colnames(rets))
print(w)
w*5000
library(quantmod)
library(PerformanceAnalytics)
library(magrittr)
library(tidyr)
library(dplyr)
library(corrplot)
library(nloptr)
symbols = c('ARKK',
'JETS',
'PBW',
'XLY',
'XLP',
'NRGU',
'PAVE',
'FNGU',
'FAS'
)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind,
lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
covmat = cov(rets)
library(cccp)
opt = rp(x0 = rep(1/length(symbols),length(symbols)),
P = covmat,
mrc = rep(1/length(symbols),length(symbols)))
w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
round(., 4) %>%
setNames(colnames(rets))
print(w)
w*5000
library(quantmod)
library(PerformanceAnalytics)
library(magrittr)
library(tidyr)
library(dplyr)
library(corrplot)
library(nloptr)
symbols = c('XLP',
'XLY',
'JETS',
'PAVE',
'PBW',
'ARKK',
'NRGU',
'FNGU',
'FAS'
)
getSymbols(symbols, src = 'yahoo')
prices = do.call(cbind,
lapply(symbols, function(x) Ad(get(x)))) %>%
setNames(symbols)
rets = Return.calculate(prices) %>% na.omit()
cor(rets) %>%
corrplot(method = 'color', type = 'upper',
addCoef.col = 'black', number.cex = 0.7,
tl.cex = 0.6, tl.srt=45, tl.col = 'black',
col =
colorRampPalette(c('blue', 'white', 'red'))(200),
mar = c(0,0,0.5,0))
covmat = cov(rets)
library(cccp)
opt = rp(x0 = rep(1/length(symbols),length(symbols)),
P = covmat,
mrc = rep(1/length(symbols),length(symbols)))
w = getx(opt) %>% drop()
w = (w / sum(w)) %>%
round(., 4) %>%
setNames(colnames(rets))
print(w)
w*5100
?shift
print(paste0(Sys.time()," : Starting Script"))
library(RPostgres)
library(DBI)
library(jsonlite)
dbConfig=read_json("./config.json")$database
conn<-dbConnect(RPostgres::Postgres(),dbname=dbConfig$database,host=dbConfig$host,port=dbConfig$port,user=dbConfig$user,password=dbConfig$passwd)
#함수 불러돌이기
FfsQ<-data.table(dbGetQuery(conn,SQL("SELECT * from metainfo.분기재무제표")))
library(data.table)
FfsQ<-data.table(dbGetQuery(conn,SQL("SELECT * from metainfo.분기재무제표")))
?shift
FfsQ
DT[, cum.sum := Reduce(`+`, shift(값, 0:3)), by=c("종목코드","종류","계정")]
FfsQ[, cum.sum := Reduce(`+`, shift(값, 0:3)), by=c("종목코드","종류","계정")]
FfsQ[, cum.sum := Reduce(`+`, shift('값', 0:3)), by=c("종목코드","종류","계정")]
FfsQ[, cum.sum := Reduce(`+`, shift('값', 0:3)), by=c("종목코드","종류","계정","일자")]
FfsQ[, cum.sum := Reduce('+', shift('값', 0:3)), by=c("종목코드","종류","계정","일자")]
?Reduce
FfsQ[, cum.sum := Reduce('+', shift('값', 0:3))]
?shift
DT = data.table(year=2010:2014, v1=runif(5), v2=1:5, v3=letters[1:5])
DT
DT[,shift(.SD,1:2)]
DT[, shift(.SD, 1:2, NA, "lead", TRUE), .SDcols=2:4]
DT = data.table(year=rep(2010:2011, each=3), v1=1:6)
DT
DT[, c("lag1", "lag2") := shift(.SD, 1:2), by=year]
DT
DT = data.table(x=1:6, g=rep(1:2, each=3))
DT
DT[ , shift(x, fill=x[1L]), by=g]
DT[ , shift(x), by=g]
DT[,Reduce('+', shift(g, 0:3))]
DT[,shift(g, 0:3)]
DT[,Reduce('+', shift(g, 0:3)),by=V1]
DT[,Reduce('+', shift(g, 0:3)),by='V1']
DT[,res:=Reduce('+', shift(g, 0:3)),by='V1']
DT[,res:=Reduce('+', shift(g, 0:3)),by=c('V1')]
DT[,res:=Reduce('+', shift(g, 0:3)),by=1]
DT[,res:=Reduce('+', shift(g, 0:3))]
DT
DT[,res:=Reduce('+', shift(g, 0:3)),by=x]
DT
DT[,res:=Reduce('+', shift(x, 0:3)),by=g]
DT
DT[,res:=Reduce('+', shift(x, 0:1)),by=g]
DT
FfsQ
FfsQ[,shift(값,0:3)]
FfsQ[,shift(값,0:3),by=c("종목코드",""종류","계정","일자")]
FfsQ[,shift(값,0:3),by=list("종목코드",""종류","계정","일자")]
FfsQ[,shift(값,0:3),by=list("종목코드",종류","계정","일자")]
FfsQ[,shift(값,0:3),by=c("종목코드",종류","계정","일자")]
FfsQ[,shift(값,0:3),by=c("종목코드","종류","계정","일자")]
FfsQ[,shift("값",0:3),by=c("종목코드","종류","계정","일자")]
FfsQT<-FfsQ['종목코드'==036560]
FfsQT
FfsQT<-FfsQ['종목코드'=='036560']
FfsQT
FfsQ['종목코드'=='036560']
FfsQ['종류'=='재무상태표']
FfsQ['종류'='재무상태표']
FfsQ[종류=='재무상태표']
FfsQ[종목코드=='036560']
FfsQT<-FfsQ[종목코드=='036560']
as.data.frame(FfsQT)
FfsQT[,shift("값",0:3),by=c("종목코드","종류","계정","일자")]
as.data.frame(FfsQT[,shift("값",0:3),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(값,0:3),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD,0:3),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD,0:3),by=c("종목코드","종류","계정")])
as.data.frame(FfsQT[,shift(.SD,1:3),by=c("종목코드","종류","계정")])
as.data.frame(FfsQT[,shift(.SD,1:3),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD,1:4),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD[,값],1:4),by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD,1:4),by=c("종목코드","종류","계정","일자")])
shift(FfsQT,1:3)
as.data.frame(FfsQT[,shift(.SD,1:4),type="lag",by=c("종목코드","종류","계정","일자")])
as.data.frame(FfsQT[,shift(.SD,1:4),by=c("종목코드","종류","계정","일자"),.SDcols=5])
unique(FfsQT[,일자])
FfsQT
FfsQTT<-FfsQT[계정=='영업활동으로인한현금흐름']
FfsQTT
as.data.frame(FfsQTT[,shift(.SD,1:4),by=c("종목코드","종류","계정","일자"),.SDcols=5])
as.data.frame(FfsQTT[,shift(.SD,1:4),by=c("종목코드","종류","계정"),.SDcols=5])
FfsQTT[,T:=shift(.SD,1:4),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQTT
FfsQTT[,T:=Reduce('+',shift(.SD,1:4)),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQTT
3.2+3.2+2.6+2.8
FfsQTT[,T:=Reduce('+',shift(.SD,0:3)),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQTT
FfsQTT
FfsQTT<-FfsQTT[order(일자)]
FfsQTT
FfsQ<-FfsQ[order(일자)]
FfsQ
FfsQTT[,sumT:=Reduce('+',shift(.SD,0:3)),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQ[,sumT:=Reduce('+',shift(.SD,0:3)),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQ
FfsQ[종목코드==053740]
FfsQ[종목코드=='053740']
as.data.frame(FfsQ[종목코드=='053740'])
FfsQ[종목코드=='053740'
][,sumT:=Reduce('+',shift(.SD,0:3)),by=c("종목코드","종류","계정"),.SDcols=5]
FfsQT<-FfsQ[종목코드=='005930']
FfsQT
dbGetQuery(conn,SQL("select * from metainfo.월별기업정보"))
corpTable<-as.data.table(dbGetQuery(conn,SQL("select * from metainfo.월별기업정보")))
corpTable
corpTable<-corpTable[,1:10]
corpTable
corpData<-corpTable[1,]
corpData
yearData<-FfsY
FfsY<-data.table(dbGetQuery(conn,SQL("SELECT * from metainfo.연간재무제표")))
FfsQ<-data.table(dbGetQuery(conn,SQL("SELECT * from metainfo.분기재무제표")))
yearData<-FfsY
quarterData<-FfsQ
businessDate<-as.Date(corpData[[1]],format='%Y-%m-%d')
code<-corpData[[2]]
yData<-yearData[종목코드==code]
qData<-quarterData[종목코드==code]
yData$일자<-as.character(yData$일자)
qData$일자<-as.character(qData$일자)
yDate<-as.Date(paste0(yData$일자,'.01'),format='%Y.%m.%d')
qDate<-as.Date(paste0(qData$일자,'.01'),format='%Y.%m.%d')
monthCrit<-month(yDate[1])
monthTerm<-rep(3,12)
monthTerm[monthCrit]<-4
month(yDate)<-month(yDate)+4
month(qDate)<-month(qDate)+monthTerm[month(qDate)]
lastYearDate<-businessDate %m+% months(-12)
yData<-yData[yDate>=lastYearDate]
library(lubridate)
monthCrit<-month(yDate[1])
monthTerm<-rep(3,12)
monthTerm[monthCrit]<-4
month(yDate)<-month(yDate)+4
month(qDate)<-month(qDate)+monthTerm[month(qDate)]
lastYearDate<-businessDate %m+% months(-12)
yData<-yData[yDate>=lastYearDate]
qData<-qData[qDate>=lastYearDate]
yDate<-yDate[yDate>=lastYearDate]
qDate<-qDate[qDate>=lastYearDate]
yData
qDat
qData
yDate<-yData$일자
qDate<-qData$일자
qRank<-frank(-as.double(qDate),ties.method="dense")
yRank<-frank(-as.double(yDate),ties.method="dense")
if(length(yRank) == 0 & length(unique(qRank)) < 4 ){return(result)}
curQRange<-diff(range(as.double(qDate)[qRank<5]))
data
if(length(unique(qDate))>=4 & curQRange<=1){
data<-qData[qRank<=4]
} else{ data<-yData[yRank==1] }
data
corpTable
corpData<-corpTable[종목코드=='005930']
corpData
corpData<-corpData[37]
corpData
yearData
businessDate<-as.Date(corpData[[1]],format='%Y-%m-%d')
code<-corpData[[2]]
yData<-yearData[종목코드==code]
qData<-quarterData[종목코드==code]
yData$일자<-as.character(yData$일자)
qData$일자<-as.character(qData$일자)
yDate<-as.Date(paste0(yData$일자,'.01'),format='%Y.%m.%d')
qDate<-as.Date(paste0(qData$일자,'.01'),format='%Y.%m.%d')
monthCrit<-month(yDate[1])
monthTerm<-rep(3,12)
monthTerm[monthCrit]<-4
month(yDate)<-month(yDate)+4
month(qDate)<-month(qDate)+monthTerm[month(qDate)]
lastYearDate<-businessDate %m+% months(-12)
yData<-yData[yDate>=lastYearDate]
qData<-qData[qDate>=lastYearDate]
yDate<-yDate[yDate>=lastYearDate]
qDate<-qDate[qDate>=lastYearDate]
if(!isNew){
yData<-yData[yDate<=businessDate]
qData<-qData[qDate<=businessDate]
}
yDate<-yData$일자
qDate<-qData$일자
qRank<-frank(-as.double(qDate),ties.method="dense")
yRank<-frank(-as.double(yDate),ties.method="dense")
if(length(yRank) == 0 & length(unique(qRank)) < 4 ){return(result)}
curQRange<-diff(range(as.double(qDate)[qRank<5]))
if(length(unique(qDate))>=4 & curQRange<=1){
data<-qData[qRank<=4]
} else{ data<-yData[yRank==1] }
data
data
data<-sumQuarterData(data)
sumQuarterData<-function(data){
fs<-data[data$종류=='재무상태표']
data<-data[data$종류!='재무상태표']
fs<-fs[fs$일자==max(fs$일자)]
fs<-fs[,-'일자']
if(length(unique(data$일자))>1) data<-data[,.(값=sum(값)),by=c('종목코드','종류','계정')] else{
data<-data[,-'일자']
}
names(fs)<-names(data)
data<-rbind(data,fs)
return(data)
}
data<-sumQuarterData(data)
data
fs<-data[data$종류=='재무상태표']
data<-data[data$종류!='재무상태표']
fs<-fs[fs$일자==max(fs$일자)]
fs<-fs[,-'일자']
if(length(unique(data$일자))>1) data<-data[,.(값=sum(값)),by=c('종목코드','종류','계정')] else{
data<-data[,-'일자']
}
fs
data
data[,.(값=sum(값)),by=c('종목코드','종류','계정')]
data[,.(값=sum('값')),by=c('종목코드','종류','계정')]
data[,.('값'=sum('값')),by=c('종목코드','종류','계정')]
data[,sum(값)),by=c('종목코드','종류','계정')]
data[,sum(값),by=c('종목코드','종류','계정')]
data[,sum(값)]
data[,sum(값),by=c('종목코드','종류','계정')]
data[,sum(값),by=list('종목코드','종류','계정')]
data[,sum(.SD),by=c('종목코드','종류','계정'),.SDcols=5]
data[,.(값=sum(.SD)),by=c('종목코드','종류','계정'),.SDcols=5]
data
data<-data[,.(값=sum(.SD)),by=c('종목코드','종류','계정'),.SDcols=5]
data
names(fs)<-names(data)
data<-rbind(data,fs)
data
corpData
corpData[data]
data[corpData]
data[corpData,by=종목코드]
data[corpData,on=종목코드]
data[corpData,on='종목코드']
corpData[data,on='종목코드']
data
data[,일자:=corpData[[1]]]
data
data
data<-select(data)
select
subset
subset(data,select=c(5,1,2,3,4))
corpData
corpData[,1]
corpData[,1][[1]]
corpData[[1]]
